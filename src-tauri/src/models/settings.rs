use serde::{Deserialize, Serialize};
use std::fs;
use std::path::{Path, PathBuf};
use thiserror::Error;
use crate::models::ai::{ProviderType, OllamaConfig, ClaudeConfig, HostedConfig, GeminiCliConfig};

#[derive(Debug, Error)]
pub enum SettingsError {
    #[error("Failed to read settings file: {0}")]
    ReadError(#[from] std::io::Error),

    #[error("Failed to parse settings: {0}")]
    ParseError(String),

    #[error("Failed to write settings: {0}")]
    WriteError(String),
}

/// App-wide global settings
#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct GlobalSettings {
    #[serde(default = "default_theme")]
    pub theme: String,

    #[serde(default = "default_model", alias = "default_model")]
    pub default_model: String,

    #[serde(default = "default_notifications", alias = "notifications_enabled")]
    pub notifications_enabled: bool,

    #[serde(default, alias = "projects_path")]
    pub projects_path: Option<PathBuf>,

    #[serde(default = "default_active_provider", alias = "active_provider")]
    pub active_provider: ProviderType,

    #[serde(default = "default_ollama_config")]
    pub ollama: OllamaConfig,

    #[serde(default = "default_claude_config")]
    pub claude: ClaudeConfig,

    #[serde(default = "default_hosted_config")]
    pub hosted: HostedConfig,

    #[serde(default = "default_gemini_cli_config", alias = "gemini_cli")]
    pub gemini_cli: GeminiCliConfig,

    #[serde(default)]
    pub custom_clis: Vec<crate::models::ai::CustomCliConfig>,
}

fn default_theme() -> String {
    "system".to_string()
}

fn default_model() -> String {
    "gemini-2.0-flash".to_string()
}

fn default_notifications() -> bool {
    true
}

fn default_active_provider() -> ProviderType {
    ProviderType::GeminiCli
}

fn default_ollama_config() -> OllamaConfig {
    OllamaConfig {
        model: "llama3".to_string(),
        api_url: "http://localhost:11434".to_string(),
        detected_path: None,
    }
}

fn default_claude_config() -> ClaudeConfig {
    ClaudeConfig {
        model: "claude-3-5-sonnet-20241022".to_string(),
        detected_path: None,
    }
}

fn default_hosted_config() -> HostedConfig {
    HostedConfig {
        provider: "anthropic".to_string(),
        model: "claude-3-5-sonnet-20241022".to_string(),
        api_key_secret_id: "ANTHROPIC_API_KEY".to_string(),
    }
}

fn default_gemini_cli_config() -> GeminiCliConfig {
    GeminiCliConfig {
        command: "gemini".to_string(),
        model_alias: "auto-gemini-2.5".to_string(),
        api_key_secret_id: "GEMINI_API_KEY".to_string(),
        api_key_env_var: None,
        detected_path: None,
    }
}

impl Default for GlobalSettings {
    fn default() -> Self {
        Self {
            theme: default_theme(),
            default_model: default_model(),
            notifications_enabled: default_notifications(),
            projects_path: None,
            active_provider: default_active_provider(),
            ollama: default_ollama_config(),
            claude: default_claude_config(),
            hosted: default_hosted_config(),
            gemini_cli: default_gemini_cli_config(),
            custom_clis: Vec::new(),
        }
    }
}

impl GlobalSettings {
    /// Load global settings from a file
    pub fn load<P: AsRef<Path>>(path: P) -> Result<Self, SettingsError> {
        let path = path.as_ref();

        if !path.exists() {
            return Ok(Self::default());
        }

        let content = fs::read_to_string(path)?;

        serde_json::from_str(&content)
            .map_err(|e| SettingsError::ParseError(format!("Failed to parse JSON settings: {}", e)))
    }

    /// Save global settings to a file
    pub fn save<P: AsRef<Path>>(&self, path: P) -> Result<(), SettingsError> {
        let content = serde_json::to_string_pretty(self)
            .map_err(|e| SettingsError::WriteError(format!("Failed to serialize settings: {}", e)))?;
        
        fs::write(path, content)
            .map_err(|e| SettingsError::WriteError(format!("Failed to write settings: {}", e)))?;

        Ok(())
    }
}


/// Project-specific settings
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ProjectSettings {
    #[serde(default)]
    pub name: Option<String>,

    #[serde(default)]
    pub goal: Option<String>,

    #[serde(default)]
    pub custom_prompt: Option<String>,

    #[serde(default)]
    pub preferred_skills: Vec<String>,

    #[serde(default)]
    pub auto_save: Option<bool>,

    #[serde(default)]
    pub encryption_enabled: Option<bool>,
}

impl Default for ProjectSettings {
    fn default() -> Self {
        Self {
            name: None,
            goal: None,
            custom_prompt: None,
            preferred_skills: Vec::new(),
            auto_save: Some(true),
            encryption_enabled: Some(true),
        }
    }
}

impl ProjectSettings {
    /// Load project settings from a file
    pub fn load<P: AsRef<Path>>(path: P) -> Result<Self, SettingsError> {
        let path = path.as_ref();

        if !path.exists() {
            return Ok(Self::default());
        }

        let content = fs::read_to_string(path)?;
        serde_json::from_str(&content)
            .map_err(|e| SettingsError::ParseError(format!("Failed to parse project JSON settings: {}", e)))
    }

    /// Save project settings to a file
    pub fn save<P: AsRef<Path>>(&self, path: P) -> Result<(), SettingsError> {
        let content = serde_json::to_string_pretty(self)
            .map_err(|e| SettingsError::WriteError(format!("Failed to serialize project settings: {}", e)))?;
        
        fs::write(path, content)
            .map_err(|e| SettingsError::WriteError(format!("Failed to write project settings: {}", e)))?;

        Ok(())
    }
}


#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_default_global_settings() {
        let settings = GlobalSettings::default();
        assert_eq!(settings.theme, "system");
        assert_eq!(settings.default_model, "gemini-2.0-flash");
    }
}
